{"ast":null,"code":"/**\n * Copyright (c) 2013-present, Facebook, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n *  strict-local\n * @format\n */\n'use strict';\n\nvar _extends3 = _interopRequireDefault(require('babel-runtime/helpers/extends'));\n\nvar _classCallCheck3 = _interopRequireDefault(require('babel-runtime/helpers/classCallCheck'));\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    'default': obj\n  };\n}\n/**\n * @internal\n *\n * Wrapper API that is an amalgam of the `RelayModernRecord` API and\n * `MutableRecordSource` interface, implementing copy-on-write semantics for\n * records in a record source. If a `backup` is supplied, the mutator will\n * ensure that the backup contains sufficient information to revert all\n * modifications by publishing the backup.\n *\n * Modifications are applied to fresh copies of records with optional backups\n * created:\n * - Records in `base` are never modified.\n * - Modifications cause a fresh version of a record to be created in `sink`.\n *   These sink records contain only modified fields.\n * - If a `backup` is supplied, any modifications to a record will cause the\n *   sink version of the record to be added to the backup.\n * - Creation of a record causes a sentinel object to be added to the backup\n *   so that the new record can be removed from the store by publishing the\n *   backup.\n */\n\n\nvar RelayRecordSourceMutator = function () {\n  function RelayRecordSourceMutator(base, sink, backup) {\n    (0, _classCallCheck3['default'])(this, RelayRecordSourceMutator);\n    this._backup = backup;\n    this._base = base;\n    this._sink = sink;\n    this.__sources = [sink, base];\n  }\n\n  RelayRecordSourceMutator.prototype._createBackupRecord = function _createBackupRecord(dataID) {\n    var backup = this._backup;\n\n    if (backup && !backup.has(dataID)) {\n      var baseRecord = this._base.get(dataID);\n\n      if (baseRecord != null) {\n        backup.set(dataID, baseRecord);\n      } else if (baseRecord === null) {\n        backup['delete'](dataID);\n      }\n    }\n  };\n\n  RelayRecordSourceMutator.prototype._setSentinelFieldsInBackupRecord = function _setSentinelFieldsInBackupRecord(dataID, record) {\n    var backup = this._backup;\n\n    if (backup) {\n      var backupRecord = backup.get(dataID);\n\n      if (backupRecord && backupRecord !== require('./RelayStoreUtils').UNPUBLISH_RECORD_SENTINEL) {\n        var copy = null;\n\n        for (var key in record) {\n          if (record.hasOwnProperty(key)) {\n            if (!(key in backupRecord)) {\n              copy = copy || (0, _extends3['default'])({}, backupRecord);\n              copy[key] = require('./RelayStoreUtils').UNPUBLISH_FIELD_SENTINEL;\n            }\n          }\n        }\n\n        backup.set(dataID, copy || backupRecord);\n      }\n    }\n  };\n\n  RelayRecordSourceMutator.prototype._setSentinelFieldInBackupRecord = function _setSentinelFieldInBackupRecord(dataID, storageKey) {\n    var backup = this._backup;\n\n    if (backup) {\n      var backupRecord = backup.get(dataID);\n\n      if (backupRecord && backupRecord !== require('./RelayStoreUtils').UNPUBLISH_RECORD_SENTINEL && !(storageKey in backupRecord)) {\n        var copy = (0, _extends3['default'])({}, backupRecord);\n\n        require('./RelayModernRecord').setValue(copy, storageKey, require('./RelayStoreUtils').UNPUBLISH_FIELD_SENTINEL);\n\n        backup.set(dataID, copy);\n      }\n    }\n  };\n\n  RelayRecordSourceMutator.prototype._getSinkRecord = function _getSinkRecord(dataID) {\n    var sinkRecord = this._sink.get(dataID);\n\n    if (!sinkRecord) {\n      var baseRecord = this._base.get(dataID);\n\n      !baseRecord ? process.env.NODE_ENV !== 'production' ? require('fbjs/lib/invariant')(false, 'RelayRecordSourceMutator: Cannot modify non-existent record `%s`.', dataID) : require('fbjs/lib/invariant')(false) : void 0;\n      sinkRecord = require('./RelayModernRecord').create(dataID, require('./RelayModernRecord').getType(baseRecord));\n\n      this._sink.set(dataID, sinkRecord);\n    }\n\n    return sinkRecord;\n  };\n\n  RelayRecordSourceMutator.prototype.copyFields = function copyFields(sourceID, sinkID) {\n    var sinkSource = this._sink.get(sourceID);\n\n    var baseSource = this._base.get(sourceID);\n\n    !(sinkSource || baseSource) ? process.env.NODE_ENV !== 'production' ? require('fbjs/lib/invariant')(false, 'RelayRecordSourceMutator#copyFields(): Cannot copy fields from ' + 'non-existent record `%s`.', sourceID) : require('fbjs/lib/invariant')(false) : void 0;\n\n    this._createBackupRecord(sinkID);\n\n    var sink = this._getSinkRecord(sinkID);\n\n    if (baseSource) {\n      require('./RelayModernRecord').copyFields(baseSource, sink);\n    }\n\n    if (sinkSource) {\n      require('./RelayModernRecord').copyFields(sinkSource, sink);\n    }\n\n    this._setSentinelFieldsInBackupRecord(sinkID, sink);\n  };\n\n  RelayRecordSourceMutator.prototype.copyFieldsFromRecord = function copyFieldsFromRecord(record, sinkID) {\n    this.copyFields(require('./RelayModernRecord').getDataID(record), sinkID);\n\n    var sink = this._getSinkRecord(sinkID);\n\n    require('./RelayModernRecord').copyFields(record, sink);\n\n    this._setSentinelFieldsInBackupRecord(sinkID, sink);\n  };\n\n  RelayRecordSourceMutator.prototype.create = function create(dataID, typeName) {\n    !(this._base.getStatus(dataID) !== require('./RelayRecordState').EXISTENT && this._sink.getStatus(dataID) !== require('./RelayRecordState').EXISTENT) ? process.env.NODE_ENV !== 'production' ? require('fbjs/lib/invariant')(false, 'RelayRecordSourceMutator#create(): Cannot create a record with id ' + '`%s`, this record already exists.', dataID) : require('fbjs/lib/invariant')(false) : void 0;\n\n    if (this._backup) {\n      this._backup.set(dataID, require('./RelayStoreUtils').UNPUBLISH_RECORD_SENTINEL);\n    }\n\n    var record = require('./RelayModernRecord').create(dataID, typeName);\n\n    this._sink.set(dataID, record);\n  };\n\n  RelayRecordSourceMutator.prototype['delete'] = function _delete(dataID) {\n    this._createBackupRecord(dataID);\n\n    this._sink['delete'](dataID);\n  };\n\n  RelayRecordSourceMutator.prototype.getStatus = function getStatus(dataID) {\n    return this._sink.has(dataID) ? this._sink.getStatus(dataID) : this._base.getStatus(dataID);\n  };\n\n  RelayRecordSourceMutator.prototype.getType = function getType(dataID) {\n    for (var ii = 0; ii < this.__sources.length; ii++) {\n      var record = this.__sources[ii].get(dataID);\n\n      if (record) {\n        return require('./RelayModernRecord').getType(record);\n      } else if (record === null) {\n        return null;\n      }\n    }\n  };\n\n  RelayRecordSourceMutator.prototype.getValue = function getValue(dataID, storageKey) {\n    for (var ii = 0; ii < this.__sources.length; ii++) {\n      var record = this.__sources[ii].get(dataID);\n\n      if (record) {\n        var value = require('./RelayModernRecord').getValue(record, storageKey);\n\n        if (value !== undefined) {\n          return value;\n        }\n      } else if (record === null) {\n        return null;\n      }\n    }\n  };\n\n  RelayRecordSourceMutator.prototype.setValue = function setValue(dataID, storageKey, value) {\n    this._createBackupRecord(dataID);\n\n    var sinkRecord = this._getSinkRecord(dataID);\n\n    require('./RelayModernRecord').setValue(sinkRecord, storageKey, value);\n\n    this._setSentinelFieldInBackupRecord(dataID, storageKey);\n  };\n\n  RelayRecordSourceMutator.prototype.getLinkedRecordID = function getLinkedRecordID(dataID, storageKey) {\n    for (var ii = 0; ii < this.__sources.length; ii++) {\n      var record = this.__sources[ii].get(dataID);\n\n      if (record) {\n        var linkedID = require('./RelayModernRecord').getLinkedRecordID(record, storageKey);\n\n        if (linkedID !== undefined) {\n          return linkedID;\n        }\n      } else if (record === null) {\n        return null;\n      }\n    }\n  };\n\n  RelayRecordSourceMutator.prototype.setLinkedRecordID = function setLinkedRecordID(dataID, storageKey, linkedID) {\n    this._createBackupRecord(dataID);\n\n    var sinkRecord = this._getSinkRecord(dataID);\n\n    require('./RelayModernRecord').setLinkedRecordID(sinkRecord, storageKey, linkedID);\n\n    this._setSentinelFieldInBackupRecord(dataID, storageKey);\n  };\n\n  RelayRecordSourceMutator.prototype.getLinkedRecordIDs = function getLinkedRecordIDs(dataID, storageKey) {\n    for (var ii = 0; ii < this.__sources.length; ii++) {\n      var record = this.__sources[ii].get(dataID);\n\n      if (record) {\n        var linkedIDs = require('./RelayModernRecord').getLinkedRecordIDs(record, storageKey);\n\n        if (linkedIDs !== undefined) {\n          return linkedIDs;\n        }\n      } else if (record === null) {\n        return null;\n      }\n    }\n  };\n\n  RelayRecordSourceMutator.prototype.setLinkedRecordIDs = function setLinkedRecordIDs(dataID, storageKey, linkedIDs) {\n    this._createBackupRecord(dataID);\n\n    var sinkRecord = this._getSinkRecord(dataID);\n\n    require('./RelayModernRecord').setLinkedRecordIDs(sinkRecord, storageKey, linkedIDs);\n\n    this._setSentinelFieldInBackupRecord(dataID, storageKey);\n  };\n\n  return RelayRecordSourceMutator;\n}();\n\nmodule.exports = RelayRecordSourceMutator;","map":null,"metadata":{},"sourceType":"script"}