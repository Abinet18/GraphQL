{"ast":null,"code":"/**\n * Copyright (c) 2013-present, Facebook, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * \n * @format\n */\n'use strict';\n\nvar _classCallCheck3 = _interopRequireDefault(require('babel-runtime/helpers/classCallCheck'));\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    'default': obj\n  };\n}\n\nvar RelayModernEnvironment = function () {\n  function RelayModernEnvironment(config) {\n    var _this = this;\n\n    (0, _classCallCheck3['default'])(this, RelayModernEnvironment);\n    this._deferrableSelections = new Set();\n    this.configName = config.configName;\n    var handlerProvider = config.handlerProvider ? config.handlerProvider : require('./RelayDefaultHandlerProvider');\n    this._network = config.network;\n    this._publishQueue = new (require('./RelayPublishQueue'))(config.store, handlerProvider);\n    this._store = config.store;\n    this.unstable_internal = require('./RelayCore');\n\n    this.__setNet = function (newNet) {\n      return _this._network = newNet;\n    }; // Register this Relay Environment with Relay DevTools if it exists.\n    // Note: this must always be the last step in the constructor.\n\n\n    var _global = typeof global !== 'undefined' ? global : typeof window !== 'undefined' ? window : undefined;\n\n    var devToolsHook = _global && _global.__RELAY_DEVTOOLS_HOOK__;\n\n    if (devToolsHook) {\n      devToolsHook.registerEnvironment(this);\n    }\n  }\n\n  RelayModernEnvironment.prototype.getStore = function getStore() {\n    return this._store;\n  };\n\n  RelayModernEnvironment.prototype.getNetwork = function getNetwork() {\n    return this._network;\n  };\n\n  RelayModernEnvironment.prototype.applyUpdate = function applyUpdate(optimisticUpdate) {\n    var _this2 = this;\n\n    var dispose = function dispose() {\n      _this2._publishQueue.revertUpdate(optimisticUpdate);\n\n      _this2._publishQueue.run();\n    };\n\n    this._publishQueue.applyUpdate(optimisticUpdate);\n\n    this._publishQueue.run();\n\n    return {\n      dispose: dispose\n    };\n  };\n\n  RelayModernEnvironment.prototype.revertUpdate = function revertUpdate(update) {\n    this._publishQueue.revertUpdate(update);\n\n    this._publishQueue.run();\n  };\n\n  RelayModernEnvironment.prototype.replaceUpdate = function replaceUpdate(update, newUpdate) {\n    this._publishQueue.revertUpdate(update);\n\n    this._publishQueue.applyUpdate(newUpdate);\n\n    this._publishQueue.run();\n  };\n\n  RelayModernEnvironment.prototype.applyMutation = function applyMutation(_ref) {\n    var operation = _ref.operation,\n        optimisticResponse = _ref.optimisticResponse,\n        optimisticUpdater = _ref.optimisticUpdater;\n    return this.applyUpdate({\n      operation: operation,\n      selectorStoreUpdater: optimisticUpdater,\n      response: optimisticResponse || null\n    });\n  };\n\n  RelayModernEnvironment.prototype.check = function check(readSelector) {\n    return this._store.check(readSelector);\n  };\n\n  RelayModernEnvironment.prototype.commitPayload = function commitPayload(operationSelector, payload) {\n    // Do not handle stripped nulls when commiting a payload\n    var relayPayload = require('./normalizeRelayPayload')(operationSelector.root, payload);\n\n    this._publishQueue.commitPayload(operationSelector, relayPayload);\n\n    this._publishQueue.run();\n  };\n\n  RelayModernEnvironment.prototype.commitUpdate = function commitUpdate(updater) {\n    this._publishQueue.commitUpdate(updater);\n\n    this._publishQueue.run();\n  };\n\n  RelayModernEnvironment.prototype.lookup = function lookup(readSelector) {\n    return this._store.lookup(readSelector);\n  };\n\n  RelayModernEnvironment.prototype.subscribe = function subscribe(snapshot, callback) {\n    return this._store.subscribe(snapshot, callback);\n  };\n\n  RelayModernEnvironment.prototype.retain = function retain(selector) {\n    return this._store.retain(selector);\n  };\n\n  RelayModernEnvironment.prototype.isSelectorLoading = function isSelectorLoading(selector) {\n    var key = require('./deferrableFragmentKey')(selector.dataID, selector.node.name, selector.variables);\n\n    return this._deferrableSelections.has(key);\n  };\n  /**\n   * Returns an Observable of ExecutePayload resulting from executing the\n   * provided Query or Subscription operation, each result of which is then\n   * normalized and committed to the publish queue.\n   *\n   * Note: Observables are lazy, so calling this method will do nothing until\n   * the result is subscribed to: environment.execute({...}).subscribe({...}).\n   */\n\n\n  RelayModernEnvironment.prototype.execute = function execute(_ref2) {\n    var _this3 = this;\n\n    var operation = _ref2.operation,\n        cacheConfig = _ref2.cacheConfig,\n        updater = _ref2.updater;\n    var optimisticResponse = void 0;\n    return this._network.execute(operation.node, operation.variables, cacheConfig || {})['do']({\n      next: function next(executePayload) {\n        var responsePayload = require('./normalizePayload')(executePayload);\n\n        var source = responsePayload.source,\n            fieldPayloads = responsePayload.fieldPayloads,\n            deferrableSelections = responsePayload.deferrableSelections;\n        var _iteratorNormalCompletion = true;\n        var _didIteratorError = false;\n        var _iteratorError = undefined;\n\n        try {\n          for (var _iterator = (deferrableSelections || new Set())[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n            var selectionKey = _step.value;\n\n            _this3._deferrableSelections.add(selectionKey);\n          }\n        } catch (err) {\n          _didIteratorError = true;\n          _iteratorError = err;\n        } finally {\n          try {\n            if (!_iteratorNormalCompletion && _iterator['return']) {\n              _iterator['return']();\n            }\n          } finally {\n            if (_didIteratorError) {\n              throw _iteratorError;\n            }\n          }\n        }\n\n        if (executePayload.isOptimistic) {\n          !(optimisticResponse == null) ? process.env.NODE_ENV !== 'production' ? require('fbjs/lib/invariant')(false, 'environment.execute: only support one optimistic respnose per ' + 'execute.') : require('fbjs/lib/invariant')(false) : void 0;\n          optimisticResponse = {\n            source: source,\n            fieldPayloads: fieldPayloads\n          };\n\n          _this3._publishQueue.applyUpdate(optimisticResponse);\n\n          _this3._publishQueue.run();\n        } else {\n          if (optimisticResponse) {\n            _this3._publishQueue.revertUpdate(optimisticResponse);\n\n            optimisticResponse = undefined;\n          }\n\n          var writeSelector = require('./RelayModernOperationSelector').createOperationSelector(operation.node, executePayload.variables, executePayload.operation);\n\n          if (executePayload.operation.kind === 'DeferrableOperation') {\n            var fragmentKey = require('./deferrableFragmentKey')(executePayload.variables[executePayload.operation.rootFieldVariable], executePayload.operation.fragmentName, require('./RelayConcreteVariables').getOperationVariables(executePayload.operation, executePayload.variables));\n\n            _this3._deferrableSelections['delete'](fragmentKey);\n          }\n\n          _this3._publishQueue.commitPayload(writeSelector, responsePayload, updater);\n\n          _this3._publishQueue.run();\n        }\n      }\n    })['finally'](function () {\n      if (optimisticResponse) {\n        _this3._publishQueue.revertUpdate(optimisticResponse);\n\n        optimisticResponse = undefined;\n\n        _this3._publishQueue.run();\n      }\n    });\n  };\n  /**\n   * Returns an Observable of ExecutePayload resulting from executing the\n   * provided Mutation operation, the result of which is then normalized and\n   * committed to the publish queue along with an optional optimistic response\n   * or updater.\n   *\n   * Note: Observables are lazy, so calling this method will do nothing until\n   * the result is subscribed to:\n   * environment.executeMutation({...}).subscribe({...}).\n   */\n\n\n  RelayModernEnvironment.prototype.executeMutation = function executeMutation(_ref3) {\n    var _this4 = this;\n\n    var operation = _ref3.operation,\n        optimisticResponse = _ref3.optimisticResponse,\n        optimisticUpdater = _ref3.optimisticUpdater,\n        updater = _ref3.updater,\n        uploadables = _ref3.uploadables;\n    var optimisticUpdate = void 0;\n\n    if (optimisticResponse || optimisticUpdater) {\n      optimisticUpdate = {\n        operation: operation,\n        selectorStoreUpdater: optimisticUpdater,\n        response: optimisticResponse || null\n      };\n    }\n\n    return this._network.execute(operation.node, operation.variables, {\n      force: true\n    }, uploadables)['do']({\n      start: function start() {\n        if (optimisticUpdate) {\n          _this4._publishQueue.applyUpdate(optimisticUpdate);\n\n          _this4._publishQueue.run();\n        }\n      },\n      next: function next(payload) {\n        if (optimisticUpdate) {\n          _this4._publishQueue.revertUpdate(optimisticUpdate);\n\n          optimisticUpdate = undefined;\n        }\n\n        _this4._publishQueue.commitPayload(operation, require('./normalizePayload')(payload), updater);\n\n        _this4._publishQueue.run();\n      },\n      error: function (_error) {\n        function error(_x) {\n          return _error.apply(this, arguments);\n        }\n\n        error.toString = function () {\n          return _error.toString();\n        };\n\n        return error;\n      }(function (error) {\n        if (optimisticUpdate) {\n          _this4._publishQueue.revertUpdate(optimisticUpdate);\n\n          optimisticUpdate = undefined;\n\n          _this4._publishQueue.run();\n        }\n      }),\n      unsubscribe: function unsubscribe() {\n        if (optimisticUpdate) {\n          _this4._publishQueue.revertUpdate(optimisticUpdate);\n\n          optimisticUpdate = undefined;\n\n          _this4._publishQueue.run();\n        }\n      }\n    });\n  };\n  /**\n   * @deprecated Use Environment.execute().subscribe()\n   */\n\n\n  RelayModernEnvironment.prototype.sendQuery = function sendQuery(_ref4) {\n    var cacheConfig = _ref4.cacheConfig,\n        onCompleted = _ref4.onCompleted,\n        onError = _ref4.onError,\n        onNext = _ref4.onNext,\n        operation = _ref4.operation;\n    process.env.NODE_ENV !== 'production' ? require('fbjs/lib/warning')(false, 'environment.sendQuery() is deprecated. Update to the latest ' + 'version of react-relay, and use environment.execute().') : void 0;\n    return this.execute({\n      operation: operation,\n      cacheConfig: cacheConfig\n    }).subscribeLegacy({\n      onNext: onNext,\n      onError: onError,\n      onCompleted: onCompleted\n    });\n  };\n  /**\n   * @deprecated Use Environment.execute().subscribe()\n   */\n\n\n  RelayModernEnvironment.prototype.streamQuery = function streamQuery(_ref5) {\n    var cacheConfig = _ref5.cacheConfig,\n        onCompleted = _ref5.onCompleted,\n        onError = _ref5.onError,\n        onNext = _ref5.onNext,\n        operation = _ref5.operation;\n    process.env.NODE_ENV !== 'production' ? require('fbjs/lib/warning')(false, 'environment.streamQuery() is deprecated. Update to the latest ' + 'version of react-relay, and use environment.execute().') : void 0;\n    return this.execute({\n      operation: operation,\n      cacheConfig: cacheConfig\n    }).subscribeLegacy({\n      onNext: onNext,\n      onError: onError,\n      onCompleted: onCompleted\n    });\n  };\n  /**\n   * @deprecated Use Environment.executeMutation().subscribe()\n   */\n\n\n  RelayModernEnvironment.prototype.sendMutation = function sendMutation(_ref6) {\n    var onCompleted = _ref6.onCompleted,\n        onError = _ref6.onError,\n        operation = _ref6.operation,\n        optimisticResponse = _ref6.optimisticResponse,\n        optimisticUpdater = _ref6.optimisticUpdater,\n        updater = _ref6.updater,\n        uploadables = _ref6.uploadables;\n    process.env.NODE_ENV !== 'production' ? require('fbjs/lib/warning')(false, 'environment.sendMutation() is deprecated. Update to the latest ' + 'version of react-relay, and use environment.executeMutation().') : void 0;\n    return this.executeMutation({\n      operation: operation,\n      optimisticResponse: optimisticResponse,\n      optimisticUpdater: optimisticUpdater,\n      updater: updater,\n      uploadables: uploadables\n    }).subscribeLegacy({\n      // NOTE: sendMutation has a non-standard use of onCompleted() by passing\n      // it a value. When switching to use executeMutation(), the next()\n      // Observer should be used to preserve behavior.\n      onNext: function onNext(payload) {\n        onCompleted && onCompleted(payload.response.errors);\n      },\n      onError: onError,\n      onCompleted: onCompleted\n    });\n  };\n  /**\n   * @deprecated Use Environment.execute().subscribe()\n   */\n\n\n  RelayModernEnvironment.prototype.sendSubscription = function sendSubscription(_ref7) {\n    var onCompleted = _ref7.onCompleted,\n        onNext = _ref7.onNext,\n        onError = _ref7.onError,\n        operation = _ref7.operation,\n        updater = _ref7.updater;\n    process.env.NODE_ENV !== 'production' ? require('fbjs/lib/warning')(false, 'environment.sendSubscription() is deprecated. Update to the latest ' + 'version of react-relay, and use environment.execute().') : void 0;\n    return this.execute({\n      operation: operation,\n      updater: updater,\n      cacheConfig: {\n        force: true\n      }\n    }).subscribeLegacy({\n      onNext: onNext,\n      onError: onError,\n      onCompleted: onCompleted\n    });\n  };\n\n  return RelayModernEnvironment;\n}(); // Add a sigil for detection by `isRelayModernEnvironment()` to avoid a\n// realm-specific instanceof check, and to aid in module tree-shaking to\n// avoid requiring all of RelayRuntime just to detect its environment.\n\n\nRelayModernEnvironment.prototype['@@RelayModernEnvironment'] = true;\nmodule.exports = RelayModernEnvironment;","map":null,"metadata":{},"sourceType":"script"}